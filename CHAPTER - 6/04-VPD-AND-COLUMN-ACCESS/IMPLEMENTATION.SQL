-- VPD_CLERK2
BEGIN
    DBSEC.PKG_DBSEC_ROLE_SECURITY_LEVEL.SET_CONTEXT;
END;

SELECT COUNT(*) FROM DBSEC.CUSTOMERS;

SELECT FIRST_NAME, LAST_NAME, PHONE, EMAIL 
FROM DBSEC.CUSTOMERS
WHERE ROWNUM < 6;

-- DBSEC
BEGIN 
    DBMS_RLS.DROP_POLICY(
        OBJECT_SCHEMA => 'DBSEC',
        OBJECT_NAME => 'CUSTOMERS',
        POLICY_NAME => 'DBSEC_ROLE_SECURITY_POLICY'
    );
END;

BEGIN
    DBMS_RLS.ADD_POLICY(
        OBJECT_SCHEMA => 'DBSEC',
        OBJECT_NAME => 'CUSTOMERS',
        POLICY_NAME => 'DBSEC_ROLE_SECURITY_POLICY',
        FUNCTION_SCHEMA => 'DBSEC',
        POLICY_FUNCTION => 'DBSEC_ROLE_SECURITY_LEVEL',
        STATEMENT_TYPES => 'SELECT',
        SEC_RELEVANT_COLS => 'PHONE, EMAIL',
        POLICY_TYPE => DBMS_RLS.CONTEXT_SENSITIVE,
        SEC_RELEVANT_COLS_OPT => DBMS_RLS.ALL_ROWS,
        ENABLE => TRUE
    );
END;

-- VPD_CLERK2
BEGIN
    DBSEC.PKG_DBSEC_ROLE_SECURITY_LEVEL.SET_CONTEXT;
END;
/

SELECT COUNT(*) FROM DBSEC.CUSTOMERS;

SELECT FIRST_NAME, LAST_NAME, PHONE, EMAIL 
FROM DBSEC.CUSTOMERS
WHERE ROWNUM < 6;

-- CLEANUP
BEGIN
    DBMS_RLS.ENABLE_POLICY(
        OBJECT_SCHEMA => 'DBSEC',
        OBJECT_NAME => 'CUSTOMERS',
        POLICY_NAME => 'DBSEC_ROLE_SECURITY_POLICY',
        ENABLE => FALSE
    );
END;