-- SYS
CREATE USER DBSEC IDENTIFIED BY tiger
/

GRANT CREATE SESSION TO DBSEC
/

GRANT ALL PRIVILEGES TO DBSEC
/

GRANT EXECUTE ON DBMS_RLS TO DBSEC
/

-- DBSEC
CREATE TABLE CUSTOMERS(
    SALES_REP_ID NUMBER(4),
    CUSTOMER_ID NUMBER(8),
    CUSTOMER_SSN VARCHAR2(9),
    FIRST_NAME VARCHAR2(20),
    LAST_NAME VARCHAR2(20),
    ADDR_LINE VARCHAR2(80),
    CITY VARCHAR2(30),
    STATE VARCHAR2(30),
    ZIP_CODE VARCHAR2(9),
    PHONE VARCHAR2(15),
    EMAIL VARCHAR2(80),
    CC_NUMBER VARCHAR2(20),
    CREDIT_LIMIT NUMBER,
    GENDER CHAR(1),
    STATUS CHAR(1),
    COMMENTS VARCHAR2(1024),
    CTL_UPD_DTTM DATE,
    CTL_UPD_USER VARCHAR2(30),
    CTL_REC_STAT CHAR(1)
)

BEGIN
    FOR i IN 1..100 LOOP
        INSERT INTO CUSTOMERS (
            SALES_REP_ID, CUSTOMER_ID, CUSTOMER_SSN, FIRST_NAME, LAST_NAME, ADDR_LINE, CITY, STATE, ZIP_CODE, PHONE, EMAIL, CC_NUMBER, CREDIT_LIMIT, GENDER, STATUS, COMMENTS, CTL_UPD_DTTM, CTL_UPD_USER, CTL_REC_STAT
        ) VALUES (
            CASE MOD(i, 8) 
                WHEN 0 THEN 2200 
                WHEN 1 THEN 2336 
                WHEN 2 THEN 4587 
                WHEN 3 THEN 4710 
                WHEN 4 THEN 5605 
                WHEN 5 THEN 6415 
                WHEN 6 THEN 7719 
                ELSE 9644 
            END,
            i,
            LPAD(ROUND(DBMS_RANDOM.VALUE(100000000, 999999999)), 9, '0'),
            DBMS_RANDOM.STRING('U', 10),
            DBMS_RANDOM.STRING('U', 10),
            DBMS_RANDOM.STRING('U', 20) || ' Street',
            DBMS_RANDOM.STRING('U', 10),
            DBMS_RANDOM.STRING('U', 10),
            LPAD(ROUND(DBMS_RANDOM.VALUE(10000, 99999)), 9, '0'),
            '555-' || TO_CHAR(ROUND(DBMS_RANDOM.VALUE(100, 999))) || '-' || TO_CHAR(ROUND(DBMS_RANDOM.VALUE(1000, 9999))),
            DBMS_RANDOM.STRING('U', 10) || '@example.com',
            LPAD(ROUND(DBMS_RANDOM.VALUE(4000000000000000, 4999999999999999)), 16, '0'),
            ROUND(DBMS_RANDOM.VALUE(1000, 50000)),
            CASE WHEN MOD(i, 2) = 0 THEN 'M' ELSE 'F' END,
            CASE WHEN MOD(i, 3) = 0 THEN 'A' ELSE 'I' END,
            DBMS_RANDOM.STRING('U', 50),
            SYSDATE - DBMS_RANDOM.VALUE(0, 1000),
            CASE MOD(i, 3) 
                WHEN 0 THEN 'VPD_CLERK1' 
                WHEN 1 THEN 'VPD_CLERK2' 
                ELSE 'VPD_CLERK3' 
            END,
            TO_CHAR(ROUND(DBMS_RANDOM.VALUE(1, 5)))
        );
    END LOOP;
    COMMIT;
END;

SELECT * FROM CUSTOMERS;

-- USED FOR SCENARIO #1
SELECT CTL_UPD_USER, COUNT (*)
FROM CUSTOMERS
GROUP BY CTL_UPD_USER
/

-- USED FOR SCENARIO #2
SELECT SALES_REP_ID, COUNT (*)
FROM CUSTOMERS
GROUP BY SALES_REP_ID
/

-- USED FOR SCENARIO #3
SELECT CTL_REC_STAT, COUNT(*)
FROM CUSTOMERS
GROUP BY CTL_REC_STAT
/

-- VPD_CLERK1
CREATE USER VPD_CLERK1 IDENTIFIED BY VPD_CLERK1
/

GRANT CREATE SESSION TO VPD_CLERK1
/

-- VPD_CLERK2
CREATE USER VPD_CLERK2 IDENTIFIED BY VPD_CLERK2
/

GRANT CREATE SESSION TO VPD_CLERK2
/

-- VPD_CLERK3
CREATE USER VPD_CLERK3 IDENTIFIED BY VPD_CLERK3
/

GRANT CREATE SESSION TO VPD_CLERK3
/

GRANT SELECT, INSERT, UPDATE, DELETE ON CUSTOMERS TO VPD_CLERK1
/

GRANT SELECT, INSERT, UPDATE, DELETE ON CUSTOMERS TO VPD_CLERK2
/

GRANT SELECT, INSERT, UPDATE, DELETE ON CUSTOMERS TO VPD_CLERK3
/

CREATE OR REPLACE FUNCTION DBSEC_ROW_OWNER_WHERE (
    p_schema IN VARCHAR2,
    p_table IN VARCHAR2
) RETURN VARCHAR2 AS
BEGIN
    RETURN 'CTL_UPD_USER = SYS_CONTEXT(''USERENV'', ''SESSION_USER'')';
END;
/

BEGIN
    DBMS_RLS.ADD_POLICY(
        OBJECT_SCHEMA => 'DBSEC', 
        OBJECT_NAME => 'CUSTOMERS', 
        POLICY_NAME => 'DBSEC_ROW_OWNER_POLICY', 
        FUNCTION_SCHEMA => 'DBSEC', 
        POLICY_FUNCTION => 'DBSEC_ROW_OWNER_WHERE', 
        STATEMENT_TYPES => 'SELECT, UPDATE, DELETE', 
        ENABLE => TRUE);
END;
/

-- VPD_CLERK
SELECT * FROM DBSEC. CUSTOMERS
/


-- DBSEC
-- DEACTIVATE POLICY
BEGIN
    DBMS_RLS.ENABLE_POLICY(
        OBJECT_SCHEMA => 'DBSEC',
        OBJECT_NAME => 'CUSTOMERS',
        POLICY_NAME => 'DBSEC_ROW_OWNER_POLICY',
        ENABLE => FALSE
    );
END;